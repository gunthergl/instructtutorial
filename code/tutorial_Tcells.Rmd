---
title: "INsTRuCT Tutorial 2022 (T cells)"
author: "R. Astaburuaga-García, L. Petrov, G. Glehr"
output: 
  html_document:
    code_folding: 'hide'
    theme: default
    toc: true
    toc_depth: 4
    toc_float: false
editor_options: 
  chunk_output_type: inline
---

```{r setup, set.seed(1234)}
knitr::opts_chunk$set(fig.align='center', message=F, warning=F, cache=T,cache.lazy = F,
                      class.source="fold-hide")
```


--- 

## Load libraries

```{r lib}
library(tibble)
library(tidyr)
library(readr)
library(stringr)
library(ggplot2)
library(cowplot)
library(uwot)
library(Rphenograph)
library(pheatmap)
library(cytofkit)
library(needs)
library(dplyr)
library(knitr)
prioritize(dplyr)

theme_set(theme_classic())

# if(!require(devtools)){
#   install.packages("devtools") # If not already installed
# }
# devtools::install_github("JinmiaoChenLab/Rphenograph")
```

--- 

## Overview of the tutorial

In this tutorial we will analyse a public data set ([Georg _et al._ 2021](https://www.cell.com/cell/pdf/S0092-8674(21)01562-2.pdf)) of single cell phopho-proteomics measured with Cytometry by Time of Flight (CyTOF). In this study, the authors performed CyTOF of whole blood samples from mild and severe COVID-19 patients during the acute and convalescent phase, and patients with other acute respiratory infections (Flu-like illness), as well as patients chronically infected by human immunodeficiency virus (HIV) or hepatitis B (HBV) and healthy controls. They analysed the T cell space and identified highly activated CD16+ T cells in severe COVID-19, which led the authors to hypothesise about the pathological role of these cytotoxic T cells. This hypothesis was then tested and confirmed with functional analyses, and found suitable mechanisms for their induction. In this tutorial you will learn how to perform such computational analysis either in T cells, B cells, or monocytes!

Due to time constrains, we will analyse 5% of the data set. We will start by manually pre-gating the immune cell type of interest, then we will visually explore the data by reducing the dimensionality and plotting a UMAP. After this, we will cluster the data to find discrete communities of cells, using two different algorithms for comparison. Then we will annotate/give names to these clusters by looking at the average protein expression in each community/cluster. Finally, we will calculate the abundance of each cluster per donor and identify COVID-19 or severe-specific clusters. 

![](diagram.001.png)

--- 

## Read the data

We start reading the data table "data_norm_sub.csv" with the function _read.csv()_. The data was already pre-processed (filter-out dead cells, doublets, debris, and batch-corrected).

```{r read, results="hide"}
data_norm_sub <- read.csv("~/Documents/INsTRuCT_workshop/data_norm_sub5.csv")
```

What are the columns? What are the rows?

```{r colnamesdata}
colnames(data_norm_sub)
```

Create a vector with the name of each measured protein (what we call "the CyTOF panel").

```{r panelandcolors, results="hide"}
panel <- colnames(data_norm_sub)[15:54]

color_severity <- c(
  "healthy" = "#0449FF",
  "FLI" =  "#807F7F",
  "HIV" = "#40007F",
  "HBV" =  "magenta",
  "mild/moderate" = "#FFB651",
  "severe/critical" = "#F82000")

```

Let's look at how the values of markers are distributed:

```{r panel_linear, fig.height=10, fig.width=10}
data_norm_sub %>% 
    sample_frac(0.2) %>% 
    pivot_longer(names_to = "marker",values_to = "value",panel) %>%
    ggplot(aes(value)) +
    geom_density() + facet_wrap(~marker, scale = "free") + 
  theme_classic()
```

We notice that these are skewed distributions: Many small values, some very large values. Therefore, it makes more sense to look at these on a logarithmic scale:


```{r panel_log, fig.height=10, fig.width=10}
data_norm_sub %>% 
    sample_frac(0.2) %>% 
    pivot_longer(names_to = "marker",values_to = "value",panel) %>%
    mutate(log_value = log(value+1)) %>% 
    ggplot(aes(log_value)) +
    geom_density() + facet_wrap(~marker, scale = "free")+ 
    theme_classic()
```

In the CyTOF community, people commonly use the hypebolic arcsine (arcsinh) transformation: 
$$
\rm arsinh (x) = \ln(x + \sqrt{x^2+1})
$$

## Pre-gating of T cells

### CD45+CD3+

Using _ggplot()_ and _geom_point()_, generate a scatter plot to decide the gates.  
We visualize just 10% of the data.

```{r gateTcells1, fig.height=5, fig.width=5} 
data_norm_sub %>% 
 filter(CD3>0, CD45>0) %>% 
 sample_frac(0.1) %>% 
 mutate_at(vars(panel),asinh) %>% 
 filter(CD45>0, CD3>0) %>% 
 ggplot(aes(x=CD45, y=CD3)) +
 geom_point(size = 0.01, alpha = 0.1) +
 geom_density_2d()+
 geom_rect(mapping=aes(xmin=1, xmax=8, ymin=4.3, ymax=8), color="black", alpha=0) + 
  theme_classic()

```

### CD45+CD3+CD15-CD19-


```{r gateTcells2, fig.height=5, fig.width=5}
data_norm_sub %>% 
 mutate_at(vars(panel),asinh) %>% 
 filter(CD3>4.3,
               CD45>1,
               CD15>0,CD19>0) %>% 
 ggplot(aes(x=CD19, y=CD15)) +
 geom_point(size = 0.01, alpha = 0.1) +
 geom_density_2d()+
 geom_rect(mapping=aes(xmin=0, xmax=2.9, ymin=0, ymax=4), color="black", alpha=0) + 
  theme_classic()
```

### Percentage of T cells

We first add a column to the data table where each cell gets the classification T cell = {TRUE, FALSE} according to your gating strategy. Then let's see if the percentage of T cells make sense and how does it look per disease group (variable _sev_merge_). 


```{r columnTcells}
data_norm_sub <- data_norm_sub %>% mutate(Tcell = ifelse(CD3>sinh(4.3) & CD45>sinh(1) & CD15<sinh(4) & CD19<sinh(2.9), TRUE, FALSE))
```


```{r percTcells}
data_norm_sub <- data_norm_sub %>% mutate(sev_merge = factor(sev_merge,levels = c("healthy","FLI","HIV","HBV","mild/moderate","severe/critical")))

data_norm_sub %>% 
 count(id,Tcell,sev_merge,Disease.phase) %>% 
 group_by(id) %>% 
 mutate(perc = n/sum(n)*100) %>% 
 ungroup() %>% 
 filter(Tcell) %>% 
 ggplot(aes(y = perc, x = sev_merge, fill = sev_merge)) + 
 geom_boxplot(position=position_dodge(1), alpha = 0.7)+
 geom_dotplot(binaxis='y', stackdir='center',
              position=position_dodge(1), alpha = 0.7)+
 facet_grid(~ Disease.phase, space = "free_x", scale = "free_x") + 
 scale_fill_manual(values = color_severity)+
 ylab("Percentage of T cells (%)") + 
 xlab("")+
 theme_classic()+ 
 theme(axis.text.x=element_blank(),
       axis.ticks.x=element_blank())
```

### Manual gating of T cell comparment (CD4+, CD8+, TCRgd+)

We are actually interested in finding T cell communities but in each main T cell compartment (CD4+, CD8+ and TCRgd+). For this, we manually gate T cells based on CD8 and TCRgd channels.  

Gates were defined per CyTOF run. Due to time restrictions, we are providing the gates in asinh-scale. Eg.: If the cell has an asinh-signal of TCRgd lower or equal than the threshold, and a asinh-signal of CD8 lower or equal than the corresponding CD8 threshold, then the cell is CD4+.  

We then create a new column "Tcellcompartment" and classify the cell according to the gates.

```{r gatesTcells}
gates <- tibble(
 Run = as.numeric(str_sort(unique(data_norm_sub$Run))),
 CD8threshold = c(3.9,4.15,3.7,3.7,4.3,4.1,3.8,4.4,5.1,4.85,4.55,4.55,4,5,4.2),
 TCRgdthreshold = c(2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,2.85,3.7))
```

```{r applyGates}
data_Tcell <- data_norm_sub %>% filter(Tcell)

data_Tcell <- data_Tcell %>% 
 left_join(gates) %>% 
 mutate(Tcellcompartment = case_when( asinh(TCRgd) <= TCRgdthreshold & asinh(CD8) <= CD8threshold ~ "CD4+",
                                      asinh(TCRgd) <= TCRgdthreshold & asinh(CD8) > CD8threshold ~ "CD8+",
                                      TRUE ~ "TCRgd+"))


```


```{r visualizeGateTcellcompartment, fig.height=5, fig.width=8,  results = 'asis'}
data_Tcell %>% 
  mutate_at(vars(panel),asinh) %>% 
   ggplot(aes(x=CD8, y=TCRgd)) +
   geom_point(aes(color = Tcellcompartment),size = 0.5, alpha = 0.5) +
   theme_classic()+ 
   guides(colour = guide_legend(override.aes = list(size=5)))
```


```{r percTcellcompartmentAllSamples, fig.height=5, fig.width=5}
data_Tcell %>% 
 count(Tcellcompartment) %>% 
 mutate(perc = n/sum(n)*100) %>% 
 ggplot(aes(x = Tcellcompartment, y = perc, fill = Tcellcompartment, label = round(perc,2) )) + 
 geom_col(position = "dodge") + 
 geom_label() + 
  theme_classic()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), legend.position = "none") +   
 ylab("Percentage of each T cell compartment from all T cells (%)") + 
 xlab("")

```


## UMAP {.tabset}

We now compute the UMAPs for each T cell compartment across all samples (acute and convalescent), and using all markers, except the channels we used for gating, and also excluding IgD, IgM, CD21, and CD14.  

We define a vector "sel_markers_Tcells" with the selected markers to be used for the calculation of the UMAP.

```{r sel_markers_Tcells}
sel_markers_Tcells <- panel[!panel %in% c("CD45","CD3", "CD19","CD15","CD8","TCRgd","IgD","IgM","CD21","CD14")]

```

Before calculating the UMAP, is important we transform our data (_asinh_) and apply z-score normalization (function _scale_). Why?

```{r computeUMAP}

UMAP_TCRgd <- data_Tcell %>%
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "TCRgd+") %>%
  select(sel_markers_Tcells) %>%
  uwot::umap(n_neighbors = 30,spread = 1, min_dist = 0.5,metric = "euclidean", verbose = TRUE, fast_sgd = TRUE)

UMAP_CD4 <- data_Tcell %>%
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "CD4+") %>%
  select(sel_markers_Tcells)  %>%
  uwot::umap(n_neighbors = 30,spread = 1,min_dist = 0.5,metric = "euclidean", verbose = TRUE, fast_sgd = TRUE)

UMAP_CD8 <- data_Tcell %>%
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "CD8+") %>%
  select(sel_markers_Tcells) %>% 
  uwot::umap(n_neighbors = 30,spread = 1,min_dist = 0.5,metric = "euclidean", verbose = TRUE, fast_sgd = TRUE)

#### Add UMAP information to data frame

data_Tcell$UMAP1 <- NA
data_Tcell$UMAP2 <- NA

data_Tcell$UMAP1[data_Tcell$Tcellcompartment == "CD4+"] <- UMAP_CD4[,1]
data_Tcell$UMAP1[data_Tcell$Tcellcompartment == "CD8+"] <- UMAP_CD8[,1]
data_Tcell$UMAP1[data_Tcell$Tcellcompartment == "TCRgd+"] <- UMAP_TCRgd[,1]


data_Tcell$UMAP2[data_Tcell$Tcellcompartment == "CD4+"] <- UMAP_CD4[,2]
data_Tcell$UMAP2[data_Tcell$Tcellcompartment == "CD8+"] <- UMAP_CD8[,2]
data_Tcell$UMAP2[data_Tcell$Tcellcompartment == "TCRgd+"] <- UMAP_TCRgd[,2]

```

We now plot each UMAP, coloured by severity., disease phase, and intensity of a selected marker. Recommendation: subsample CD4+ and CD8+ T cells for visualization, using _sample_n_, or _sample_frac_. 

### Severity

Do you observe specific areas where CV19 samples accumulate? What does this mean?

```{r UMAP_severity, fig.height=7, fig.width=21}


p1 <- data_Tcell %>% 
  filter(Tcellcompartment == "CD4+") %>% 
  sample_n(30000) %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = sev_merge)) +
  geom_point(alpha = 0.5,size = 2)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = color_severity, name = "")+
  theme_classic() + 
  ggtitle("CD4+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) 

p2 <- data_Tcell %>% 
  filter(Tcellcompartment == "CD8+") %>% 
  sample_n(30000) %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = sev_merge)) +
  geom_point(alpha = 0.5,size = 2)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = color_severity, name = "")+
  theme_classic() + 
  ggtitle("CD8+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) 

p3 <- data_Tcell %>% 
  filter(Tcellcompartment == "TCRgd+") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = sev_merge)) +
  geom_point(alpha = 0.5,size = 3)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = color_severity, name = "")+
  theme_classic() + 
  ggtitle("TCRgd+ T cells") +
  theme(legend.position = "right", legend.direction = "vertical",plot.title = element_text(hjust = 0.5)) 


plot_grid(p1,p2,p3,nrow = 1)

```

### Disease phase

Do you observe specific areas where convalescent samples accumulate? What does this mean?

```{r UMAP_diseasephase, fig.height=7, fig.width=21}


p1 <- data_Tcell %>% 
  filter(Tcellcompartment == "CD4+", Group == "CV19") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = Disease.phase)) +
  geom_point(alpha = 0.5,size = 2)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = c("acute" = "red","convalescent"="black"), name = "")+
  theme_classic() + 
  ggtitle("CD4+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) 

p2 <- data_Tcell %>% 
  filter(Tcellcompartment == "CD8+", Group == "CV19") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = Disease.phase)) +
  geom_point(alpha = 0.5,size = 2)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = c("acute" = "red","convalescent"="black"), name = "")+
  theme_classic() + 
  ggtitle("CD8+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) 

p3 <- data_Tcell %>% 
  filter(Tcellcompartment == "TCRgd+", Group == "CV19") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = Disease.phase)) +
  geom_point(alpha = 0.5,size = 3)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  scale_color_manual(values = c("acute" = "red","convalescent"="black"), name = "")+
  theme_classic() + 
  ggtitle("TCRgd+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) 


plot_grid(p1,p2,p3,nrow = 1)

```

### Marker intensity

Remember to do the corresponding transformations on the intensity values.


```{r UMAP_markers, fig.height=7, fig.width=21}

p1 <- data_Tcell %>% 
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "CD4+") %>% 
  sample_n(30000) %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = HLADR)) +
  geom_point(alpha = 0.5,size = 2)+
  theme_classic() + 
  ggtitle("CD4+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) +
  scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0)


p2 <- data_Tcell %>% 
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "CD8+") %>% 
  sample_n(30000) %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = HLADR)) +
  geom_point(alpha = 0.5,size = 2)+
  theme_classic() + 
  ggtitle("CD8+ T cells") +
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) +
  scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0)


p3 <- data_Tcell %>% 
  mutate_at(vars(sel_markers_Tcells), asinh) %>% 
  mutate_at(vars(sel_markers_Tcells), scale) %>% 
  filter(Tcellcompartment == "TCRgd+") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = HLADR)) +
  geom_point(alpha = 0.5,size = 3)+
  theme_classic() + 
  ggtitle("TCRgd+ T cells") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0)

plot_grid(p1,p2,p3,nrow = 1)

```


## Unsupervised clustering  {.tabset}

We now perform unsupervised clustering analysis on samples from control, FLI, HIV, HBV, and acute COVID-19 using  the selected markers. As done for the UMAP calculation, before clustering is important we transform and z-score normalize our data.  

Due to time constraints, we will only cluster one T cell compartment, eg.: CD8+ T cells.  

**What's the main difference between RPhenograph and FlowSOM?**

### RPhenograph 

```{r runRphenograph, results="hide"}
start_time <- Sys.time()


clust_cd8_rpheno <- data_Tcell %>% 
 mutate_at(vars(sel_markers_Tcells), asinh) %>% 
 mutate_at(vars(sel_markers_Tcells), scale) %>% 
 filter(Tcellcompartment == "CD8+",Disease.phase == "acute") %>%
 select(sel_markers_Tcells) %>% 
 Rphenograph(k = 30)

end_time <- Sys.time()

```

```{r time_elapsed_Rpheno}
time_elapsed <- round(as.numeric(gsub('Time difference of ', '', difftime(end_time, start_time, units = "mins"))), 2)
print(paste('\n', time_elapsed, 'minutes passed'))
```

After running the clustering algorithm, we add a column "Rpheno" in the data table with the cluster label for each cell:

```{r add_clust_info}
clust_ids <- data_Tcell %>% 
   filter(Tcellcompartment == "CD8+",Disease.phase == "acute") %>%
   pull(cellid)

clust_cd8_rpheno <- tibble(cellid = clust_ids, Rpheno = as.character(membership(clust_cd8_rpheno)))

data_Tcell <- data_Tcell %>% left_join(clust_cd8_rpheno)
data_Tcell <- data_Tcell %>% mutate(Rpheno = factor(Rpheno, levels = str_sort(unique(Rpheno), numeric = TRUE)))

```

We now visualize the number of cells in each cluster:

```{r clustSize, fig.height=5, fig.width=10}
 data_Tcell %>% filter(Tcellcompartment == "CD8+",data_Tcell$Disease.phase == "acute" ) %>%
 count(Rpheno) %>% 
 ggplot(aes(x = Rpheno, y = n, label = n))+
 geom_col(position = "dodge") + 
 theme_classic()+ 
 geom_label() 
```

And then plot the UMAP, this time coloured by cluster:


```{r UMAP_clusters_Rpheno, fig.height=5, fig.width=7}
data_Tcell %>% 
  filter(Tcellcompartment == "CD8+",data_Tcell$Disease.phase == "acute") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = Rpheno)) +
  geom_point(alpha = 0.5,size = 1)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  theme_classic() + 
  ggtitle("CD8+ T cells") +
  theme(plot.title = element_text(hjust = 0.5)) 


```



### FlowSOM

**IMPORTANT!** We have to define the number of clusters a priori.

```{r runflowsom, results="hide"}
start_time <- Sys.time()

clust_cd8_flowsom <- data_Tcell %>% 
 mutate_at(vars(sel_markers_Tcells), asinh) %>% 
 mutate_at(vars(sel_markers_Tcells), scale) %>% 
 filter(Tcellcompartment == "CD8+",Disease.phase == "acute") %>%
 select(sel_markers_Tcells) %>% 
 cytof_cluster(xdata=. , method = 'FlowSOM', FlowSOM_k = 10)

end_time <- Sys.time()
```

```{r time_elapsed_fs}
time_elapsed <- round(as.numeric(gsub('Time difference of ', '', difftime(end_time, start_time, units = "mins"))), 2)
print(paste('\n', time_elapsed, 'minutes passed'))
```

After running the clustering algorithm, we add a column "flowsom" in the data table with the cluster label for each cell:

```{r add_clust_info_fs}
clust_ids <- data_Tcell %>%
  filter(Tcellcompartment == "CD8+",Disease.phase == "acute") %>%
  pull(cellid)

clust_cd8_flowsom <- tibble(cellid = clust_ids, flowsom = as.character(clust_cd8_flowsom))
data_Tcell <- data_Tcell %>% left_join(clust_cd8_flowsom)
data_Tcell <- data_Tcell %>% mutate(flowsom = factor(flowsom, levels = str_sort(unique(flowsom), numeric = TRUE)))
```

We now visualize the number of cells in each cluster:

```{r clustSize_fs, fig.height=5, fig.width=10}
 data_Tcell %>% filter(Tcellcompartment == "CD8+",data_Tcell$Disease.phase == "acute" ) %>%
 count(flowsom) %>% 
 ggplot(aes(x = flowsom, y = n, label = n))+
 geom_col(position = "dodge") + 
  theme_classic()+ 
  geom_label() 
```

And then plot the UMAP, this time coloured by cluster:

```{r UMAP_clusters_fs, fig.height=5, fig.width=7}
data_Tcell %>% 
  filter(Tcellcompartment == "CD8+",data_Tcell$Disease.phase == "acute") %>% 
  ggplot(aes(x = UMAP1, y=UMAP2, color = flowsom)) +
  geom_point(alpha = 0.5,size = 1)+
  guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) +
  theme_classic() + 
  ggtitle("CD8+ T cells") +
  theme(plot.title = element_text(hjust = 0.5)) 
```

## Cluster annotation {.tabset}

We now want to actually understand what are these clusters we found. For this, we can visualize the average expression of each marker in each cluster with a heatmap.** Remember to do the corresponding transformation of the intensity values.** 

### RPhenograph {.tabset}

#### ggplot

```{r heatmapClusters, fig.height=5, fig.width=5}

data_Tcell %>%
 mutate_at(vars(sel_markers_Tcells), asinh) %>%
 mutate_at(vars(sel_markers_Tcells), scale) %>%
 filter(Tcellcompartment == "CD8+",Disease.phase == "acute") %>%
 select(sel_markers_Tcells,Rpheno) %>%
 group_by(Rpheno) %>%
 summarise_at(vars(sel_markers_Tcells), funs(mean(., na.rm=TRUE))) %>%
 pivot_longer(names_to = "markers", values_to = "avg_zscore", - Rpheno) %>%
 mutate(markers = factor(markers,levels = sel_markers_Tcells)) %>%
 ggplot(aes(x = Rpheno, y = markers, fill = avg_zscore)) +
 geom_tile() +
 scale_fill_gradient2(low = "blue", mid = "white", high = "red", limits = c(-4,4))

```

#### pheatmap


With the library "pheatmap" we can additionally group the clusters (dendogram) and markers by their similarities.

```{r heatmapClusters_pheatmap, fig.height=5, fig.width=5}

data_heatmap <- data_Tcell %>%
 mutate_at(vars(sel_markers_Tcells), asinh) %>%
 mutate_at(vars(sel_markers_Tcells), scale) %>%
 filter(Tcellcompartment == "CD8+" & Disease.phase == "acute") %>%
 select(sel_markers_Tcells,Rpheno) %>%
 group_by(Rpheno) %>%
 summarise_at(vars(sel_markers_Tcells), funs(mean(., na.rm=TRUE))) %>%
 column_to_rownames("Rpheno")

data_heatmap %>% t() %>%
  pheatmap()


```

### FlowSOM {.tabset}

#### ggplot


```{r heatmapClusters_fs, fig.height=5, fig.width=5}
data_Tcell %>% 
 mutate_at(vars(sel_markers_Tcells), asinh) %>% 
 mutate_at(vars(sel_markers_Tcells), scale) %>% 
 filter(Tcellcompartment == "CD8+" & Disease.phase == "acute") %>%
 select(sel_markers_Tcells,flowsom) %>%
 group_by(flowsom) %>%
 summarise_at(vars(sel_markers_Tcells), funs(mean(., na.rm=TRUE))) %>% 
 pivot_longer(names_to = "markers", values_to = "avg_zscore", - flowsom) %>% 
 mutate(markers = factor(markers,levels = sel_markers_Tcells)) %>% 
 ggplot(aes(x = flowsom, y = markers, fill = avg_zscore)) + 
 geom_tile() + 
 scale_fill_gradient2(low = "blue", mid = "white", high = "red", limits = c(-4,4)) 
```

#### pheatmap

With the library "pheatmap" we can additionally group the clusters (dendogram) and markers by their similarities.

```{r heatmapClusters_pheatmap_fs, fig.height=5, fig.width=5}

data_heatmap <- data_Tcell %>%
 mutate_at(vars(sel_markers_Tcells), asinh) %>%
 mutate_at(vars(sel_markers_Tcells), scale) %>%
 filter(Tcellcompartment == "CD8+" & Disease.phase == "acute") %>%
 select(sel_markers_Tcells,flowsom) %>%
 group_by(flowsom) %>%
 summarise_at(vars(sel_markers_Tcells), funs(mean(., na.rm=TRUE))) %>%
 column_to_rownames("flowsom")

data_heatmap %>% t() %>%
  pheatmap()


```


### Quick comparison

How much percentage of cells from RPhenograph cluster X where classified in FlowSOM cluster Y?

```{r}

data_heatmap <- data_Tcell %>%  
    filter(Tcellcompartment == "CD8+" & Disease.phase == "acute") %>%
    count(Rpheno, flowsom) %>% 
    tidyr::complete(Rpheno,flowsom,fill = list(n=0)) %>% 
    group_by(Rpheno) %>% 
    mutate(total_Rpheno = sum(n)) %>% 
    ungroup() %>% mutate(perc = n/total_Rpheno*100) %>% select(Rpheno, flowsom, perc) %>% 
    pivot_wider(names_from = Rpheno, values_from = "perc") %>% 
    column_to_rownames("flowsom") 


pheatmap(data_heatmap, cluster_cols = T,cluster_rows = T,
         labels_row = paste0(rownames(data_heatmap), "_flowsom"),
         labels_col = paste0(rownames(data_heatmap), "_rpheno"))
```

## Cluster abundance {.tabset}

Finally, we can calculate the abundance of each cluster in each sample and check if there are COVID-specific or severity-specific groups of cells.  

**ACHTUNG!** In this data set, donors where sampled multiple times during the disease course. We establish an arbitrary rule of choosing the first sample per donor (usually during the first week post-symptom onset) if multiple samples are available.



```{r defineIDs}
selected_ids <- data_Tcell %>% 
 filter(Disease.phase == "acute") %>% 
 count(Individuals,id,Group,sev_merge,Days.post.symptom.onset) %>% 
 select(-n) %>% 
 group_by(Individuals) %>%
 mutate(n_samples = 1:n()) %>% 
 mutate(select_id = ifelse(n_samples == 1, TRUE,
                                  ifelse(min(as.numeric(Days.post.symptom.onset)) == as.numeric(Days.post.symptom.onset), 
                                         TRUE,
                                         FALSE))) %>%
 filter(select_id) %>%
 pull(id)
```

We can visualize the abundance of each cluster per donor as boxplots per severity group. 

### RPhenograph


```{r boxplot_clust_abundance, fig.height=10, fig.width=10}

 data_Tcell %>% 
 filter(id %in% selected_ids, Tcellcompartment == "CD8+") %>% 
 count(id,sev_merge,Tcellcompartment,Rpheno) %>% 
 group_by(id,Tcellcompartment) %>% 
 mutate(perc = n/sum(n)*100) %>% 
 ungroup() %>% 
  # When using the function count(), if a cluster is absent in a donor, it will not be counted as zero. 
  # So we complete the count table by filling the missing clusters with a 0.
 tidyr::complete(id,Rpheno,fill = list(n=0,perc = 0)) %>% 
 ungroup() %>% 
 group_by(Rpheno) %>% 
 fill(Tcellcompartment, .direction = "downup") %>% 
 ungroup() %>% 
 group_by(id) %>% 
 fill(sev_merge, .direction = "downup") %>% 
 ungroup() %>% 
 mutate(perc = ifelse(is.na(perc),0,perc)) %>% 
 filter(!is.na(Tcellcompartment)) %>% 
 ggplot(aes(x = sev_merge, y = perc, fill = sev_merge)) + 
 geom_boxplot() + 
 geom_jitter()+
 facet_wrap(~Rpheno, scale = "free") + 
 scale_fill_manual(values = color_severity) + 
 theme(axis.text.x = element_blank()) + 
 ggtitle("RPhenograph cluster abundance")

```

### FlowSOM

```{r boxplot_clust_flow_abundance, fig.height=10, fig.width=10}
 data_Tcell %>% 
 filter(id %in% selected_ids, Tcellcompartment == "CD8+") %>% 
 count(id,sev_merge,Tcellcompartment,flowsom) %>% 
 group_by(id,Tcellcompartment) %>% 
 mutate(perc = n/sum(n)*100) %>% 
 ungroup() %>% 
  # When using the function count(), if a cluster is absent in a donor, it will not be counted as zero. 
  # So we complete the count table by filling the missing clusters with a 0.
 tidyr::complete(id,flowsom,fill = list(n=0,perc = 0)) %>%
 ungroup() %>%
 group_by(flowsom) %>%
 fill(Tcellcompartment, .direction = "downup") %>%
 ungroup() %>%
 group_by(id) %>%
 fill(sev_merge, .direction = "downup") %>%
 ungroup() %>%
 mutate(perc = ifelse(is.na(perc),0,perc)) %>%
 filter(!is.na(Tcellcompartment)) %>%
 ggplot(aes(x = sev_merge, y = perc, fill = sev_merge)) + 
 geom_boxplot() + 
 geom_jitter()+
 facet_wrap(~flowsom, scale = "free") + 
 scale_fill_manual(values = color_severity) + 
 theme(axis.text.x = element_blank()) +
  ggtitle('FlowSom cluster abundance')
```

## Now is your turn

Make a presentation/talk (up to 20 minutes long, 10 minutes discussion) about the analysis pipeline that you familiarized yourself with. Mention what cell type you looked at, and present the results with your interpretation given the context of the experimental design.  

Doesn’t have to be a proper PowerPoint, you can just open the R Markdown and go through it.  

Following questions should be touched upon:  

* Pre-gating: 
  + What is the purpose of doing it? 
  + List pros and cons

* UMAP: 
  + What information does it carry? 
  + In what ways can we use it in exploratory analysis?
  
*	Unsupervised Clustering: 
  + What are the differences between algorithms?
  + Which one gave better results?
  + What are the situations where you would prefer using the other one?
  
* Cluster annotation
  + Which names would you give to the clusters we found?

* Interpretation of results in the context of acute COVID-19 using heatmaps and cluster abundances.
* Feedback: was it helpful? :)






<!-- ## Monocytes -->

<!-- ### Manual Gating  -->

<!-- * Using ggplot and geom_point, generate a scatter plot to decide the gates. Visualize just 10% of the data. -->
<!-- * Visualize the gates, using eg.: geom_rect. -->

<!-- #### CD45+CD3- -->

<!-- * Exclude T cells  -->

<!-- ```{r gateMono1, fig.height=5, fig.width=5}  -->
<!-- data_norm_sub %>%  -->
<!--  filter(CD3>0, CD45>0) %>%  -->
<!--  sample_frac(0.1) %>%  -->
<!--  mutate_at(vars(panel),asinh) %>%  -->
<!--  filter(CD45>0, CD3>0) %>%  -->
<!--  ggplot(aes(x=CD45, y=CD3)) + -->
<!--  geom_point(size = 0.01, alpha = 0.1) + -->
<!--  geom_density_2d()+ -->
<!--  geom_rect(mapping=aes(xmin=1, xmax=6.5, ymin=0, ymax=3.8), color="black", alpha=0)  -->

<!-- ``` -->

<!-- #### CD45+CD3-CD19-CD56- -->

<!-- * Exclude B cells and NK cells -->

<!-- ```{r gateMono2, fig.height=5, fig.width=5}  -->
<!-- data_norm_sub %>%  -->
<!--   mutate_at(vars(panel),asinh) %>%  -->
<!--  filter(CD45>1, -->
<!--                CD45<6.5, -->
<!--                CD3<3.8,  -->
<!--                CD19>0, -->
<!--                CD56>0) %>%  -->
<!--  sample_frac(0.5) %>%  -->
<!--  ggplot(aes(x=CD19, y=CD56)) + -->
<!--  geom_point(size = 0.01, alpha = 0.1) + -->
<!--  geom_density_2d() + -->
<!--  geom_rect(mapping=aes(xmin=0, xmax=3.8, ymin=0, ymax=3.5), color="black", alpha=0)  -->

<!-- ``` -->

<!-- #### CD45+CD3-CD19-CD56-HLADR+CD14+ -->

<!-- We exclude Neutrophils, and end up with monocytes and dendritic cells -->

<!-- ```{r gateMono3, fig.height=5, fig.width=5}  -->

<!-- data_norm_sub %>%  -->
<!--   mutate_at(vars(panel),asinh) %>%  -->
<!--  filter(CD45>1, -->
<!--                CD45<6.5, -->
<!--                CD3<3.8,  -->
<!--                CD19<3.8, -->
<!--                CD56<3.5, -->
<!--                HLADR>0, -->
<!--                CD14>0) %>%  -->
<!--  sample_frac(0.5) %>%  -->
<!--  ggplot(aes(x=HLADR, y=CD14)) + -->
<!--  geom_point(size = 0.01, alpha = 0.1) + -->
<!--  geom_density_2d() + -->
<!-- geom_rect(mapping=aes(xmin=0, xmax=7, ymin=5.2, ymax=9), color="black", alpha=0) + -->
<!--  geom_rect(mapping=aes(xmin=3, xmax=7, ymin=0, ymax=5.2), color="black", alpha=0)  -->
<!-- ``` -->

<!-- #### Percentage of monocytes -->

<!-- * Add a column to the data table where each cell gets the classification Monocyte = {TRUE, FALSE} according to your gating strategy. -->
<!-- * Calculate the percentage of monocytes in each sample -->
<!-- * Visualize the percentage of monocytes grouped by severity group (use the classification "sev_merge"), using eg.: geom_boxplot, and facet by disease phase. -->


<!-- ```{r columnMono} -->
<!-- data_norm_sub <- data_norm_sub %>% mutate(Monocyte = ifelse(CD45>sinh(1) & -->
<!--                CD45<sinh(6.5) & -->
<!--                CD3<sinh(3.8) & -->
<!--                CD19<sinh(3.8) & -->
<!--                CD56<sinh(3.5) , TRUE, FALSE)) -->

<!-- data_norm_sub <- data_norm_sub %>%  -->
<!--     mutate(Monocyte = ifelse(HLADR < sinh(3) &  -->
<!--                              CD14 < sinh(5.2) , FALSE, Monocyte)) -->
<!-- ``` -->


<!-- ```{r percMonocytes} -->

<!-- data_norm_sub %>%  -->
<!--  count(id,Monocyte,sev_merge,Disease.phase) %>%  -->
<!--  group_by(id) %>%  -->
<!--  mutate(perc = n/sum(n)*100) %>%  -->
<!--  ungroup() %>%  -->
<!--  filter(Monocyte) %>%  -->
<!--  ggplot(aes(y = perc, x = sev_merge, fill = sev_merge)) +  -->
<!--  geom_boxplot(position=position_dodge(1), alpha = 0.7)+ -->
<!--  geom_dotplot(binaxis='y', stackdir='center', -->
<!--               position=position_dodge(1), alpha = 0.7)+ -->
<!--  facet_grid(~ Disease.phase, space = "free_x", scale = "free_x") +  -->
<!--  scale_fill_manual(values = color_severity)+ -->
<!--  ylab("Percentage of monocytes (%)") +  -->
<!--  xlab("")+ -->
<!--  theme(axis.text.x=element_blank(), -->
<!--        axis.ticks.x=element_blank()) -->
<!-- ``` -->


<!-- ### UMAP {.tabset} -->

<!-- * Compute the UMAPs for monocytes across all samples (acute and convalescent), and using all markers, except CD45, CD3, CD19, IgM, CD21, and IgD  -->
<!-- * Define a vector "sel_markers_mono" with the selected markers to be used for the calculation of the UMAP. -->

<!-- ```{r sel_markers_mono} -->
<!-- sel_markers_mono <- panel[!panel %in% c("CD45","CD3", "CD19","CD15","TCRgd" ,"CD21", "IgM","IgD")] -->

<!-- ``` -->

<!-- * Before calculation of the UMAP, is important we transform our data ("asinh") and apply z-score normalization (function "scale"). Why? -->

<!-- ```{r computeUMAP_m} -->

<!-- data_mono <- data_norm_sub %>% -->
<!--   filter(Monocyte) -->

<!-- UMAP_mono <- data_mono %>%  -->
<!--   mutate_at(vars(sel_markers_mono), asinh) %>%  -->
<!--   mutate_at(vars(sel_markers_mono), scale) %>%  -->
<!--   select(sel_markers_mono) %>% -->
<!--   uwot::umap(n_neighbors = 30,spread = 1, min_dist = 0.5,metric = "euclidean", verbose = TRUE, fast_sgd = TRUE) -->

<!-- data_mono$UMAP1 <- NA -->
<!-- data_mono$UMAP2 <- NA -->

<!-- data_mono$UMAP1 <- UMAP_mono[,1] -->
<!-- data_mono$UMAP2 <- UMAP_mono[,2] -->

<!-- ``` -->

<!-- #### Severity -->

<!-- * Plot each UMAP, coloured by severity. -->
<!-- * Do you observe specific areas where CV19 samples accumulate? What does this mean? -->

<!-- ```{r UMAP_severity_m, fig.height=7, fig.width=7} -->

<!-- data_mono %>%  -->
<!--   sample_n(30000) %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = sev_merge)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) + -->
<!--   scale_color_manual(values = color_severity, name = "")+ -->
<!--   theme_classic() +  -->
<!--   theme(legend.position = "none",plot.title = element_text(hjust = 0.5))  -->

<!-- ``` -->

<!-- #### Disease phase -->

<!-- * Plot each UMAP using only data from COVID-19, coloured by disease phase (acute or convalescent) -->
<!-- * Do you observe specific areas where convalescent samples acumulate? What does this mean? -->

<!-- ```{r UMAP_diseasephase_m, fig.height=7, fig.width=7} -->


<!-- data_mono %>%  -->
<!--   sample_n(30000) %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = Disease.phase)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) + -->
<!--   scale_color_manual(values = c("acute" = "red","convalescent"="black"), name = "")+ -->
<!--   theme_classic() +  -->
<!--   theme(legend.position = "none",plot.title = element_text(hjust = 0.5))  -->


<!-- ``` -->

<!-- #### Marker intensity -->

<!-- * Plot the UMAPs coloured by the expression of your favorite marker. Remember to do the corresponding transformations on the intensity values. -->

<!-- ```{r UMAP_markers_m, fig.height=7, fig.width=21} -->


<!-- p1 <- data_mono %>%  -->
<!--   mutate_at(vars(sel_markers_mono), asinh) %>%  -->
<!--   mutate_at(vars(sel_markers_mono), scale) %>%  -->
<!--   sample_n(30000) %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = HLADR)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   theme_classic() +  -->
<!--   theme(plot.title = element_text(hjust = 0.5)) + -->
<!--   scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0) -->


<!-- p2 <- data_mono %>%  -->
<!--   mutate_at(vars(sel_markers_mono), asinh) %>%  -->
<!--   mutate_at(vars(sel_markers_mono), scale) %>%  -->
<!--   sample_n(30000) %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = CD16)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   theme_classic() +  -->
<!--   theme(plot.title = element_text(hjust = 0.5)) + -->
<!--   scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0) -->


<!-- p3 <- data_mono %>%  -->
<!--   mutate_at(vars(sel_markers_mono), asinh) %>%  -->
<!--   mutate_at(vars(sel_markers_mono), scale) %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = CD14)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   theme_classic() +  -->
<!--   theme(plot.title = element_text(hjust = 0.5)) + -->
<!--   scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = 0) -->

<!-- plot_grid(p1,p2,p3,nrow = 1) -->

<!-- ``` -->

<!-- ### Unsupervised clustering  {.tabset} -->

<!-- * Perform unsupervised clustering analysis on samples from control, FLI, HIV, HBV, and acute COVID-19 using all the selected markers.  -->
<!-- * As done for the UMAP calculation, before clustering is important we transform and z-score normalize our data. -->

<!-- #### RPhenograph  -->

<!-- ```{r runRphenograph_m, results="hide"} -->
<!-- clust_mono <- data_mono %>%  -->
<!--  mutate_at(vars(sel_markers_mono), asinh) %>%  -->
<!--  mutate_at(vars(sel_markers_mono), scale) %>%  -->
<!--  filter(Disease.phase == "acute") %>% -->
<!--  select(sel_markers_mono) %>%  -->
<!--  Rphenograph(k = 30) -->
<!-- ``` -->

<!-- * Add a column "Rpheno" in the main data table with the cluster label for each cell -->

<!-- ```{r add_clust_info_m} -->
<!-- clust_ids <- data_mono %>%  -->
<!--    filter(Disease.phase == "acute") %>% -->
<!--    pull(cellid) -->

<!-- clust_mono <- tibble(cellid = clust_ids, Rpheno = as.character(membership(clust_mono[[2]]))) -->

<!-- data_mono <- data_mono %>% left_join(clust_mono) -->
<!-- data_mono <- data_mono %>% mutate(Rpheno = factor(Rpheno, levels = str_sort(unique(Rpheno), numeric = TRUE))) -->

<!-- ``` -->

<!-- ##### Cluster size -->

<!-- * Visualize the number of cells in each cluster  -->

<!-- ```{r clustSize_m, fig.height=5, fig.width=10} -->
<!--  data_mono %>% filter(Disease.phase == "acute" ) %>% -->
<!--  count(Rpheno) %>%  -->
<!--  ggplot(aes(x = Rpheno, y = n, label = n))+ -->
<!--  geom_col(position = "dodge") + geom_label()  -->
<!-- ``` -->

<!-- ##### UMAP clusters -->

<!-- ```{r UMAP_clusters_m, fig.height=5, fig.width=7} -->
<!-- data_mono %>%  -->
<!--   sample_frac(0.5) %>%  -->
<!--   filter(Disease.phase == "acute") %>%  -->
<!--   ggplot(aes(x = UMAP1, y=UMAP2, color = Rpheno)) + -->
<!--   geom_point(alpha = 0.5,size = 0.5)+ -->
<!--   guides(colour = guide_legend(ncol = 1,override.aes = list(size=3, alpha = 1))) + -->
<!--   theme_classic() +  -->
<!--   theme(plot.title = element_text(hjust = 0.5))  -->


<!-- ``` -->

<!-- #### Cluster annotation -->

<!-- * To understand the clusters we found, visualize in a heatmap the average expression of each marker in each cluster. -->
<!-- * Remember to do the corresponding transformation of the intensity values. -->


<!-- ```{r heatmapClusters_m, fig.height=5, fig.width=5} -->

<!-- data_mono %>% -->
<!--  mutate_at(vars(sel_markers_mono), asinh) %>% -->
<!--  mutate_at(vars(sel_markers_mono), scale) %>% -->
<!--  filter(Disease.phase == "acute") %>% -->
<!--  select(sel_markers_mono,Rpheno) %>% -->
<!--  group_by(Rpheno) %>% -->
<!--  summarise_at(vars(sel_markers_mono), funs(mean(., na.rm=TRUE))) %>% -->
<!--  pivot_longer(names_to = "markers", values_to = "avg_zscore", - Rpheno) %>% -->
<!--  mutate(markers = factor(markers,levels = sel_markers_mono)) %>% -->
<!--  ggplot(aes(x = Rpheno, y = markers, fill = avg_zscore)) + -->
<!--  geom_tile() + -->
<!--  scale_fill_gradient2(low = "blue", mid = "white", high = "red", limits = c(-4,4)) -->

<!-- ``` -->

<!-- * With the library "ComplexHeatmap" we can additionally group the clusters (dendogram) by their similarities. -->

<!-- ```{r heatmapOriginalClusters_m, fig.height=10, fig.width=10} -->

<!-- markers_category <- c(rep("Differentiation",2), -->
<!--                      rep("Co-stimulation",4), -->
<!--                      rep("Co-inhibition",4), -->
<!--                      rep("Activation",7), -->
<!--                      rep("Chemokine receptor",4), -->
<!--                      rep("Others",9)) -->

<!-- markers_category <- factor(markers_category, -->
<!--                           levels=c("Differentiation","Co-stimulation","Co-inhibition","Activation","Chemokine receptor","Others")) -->


<!-- data_heatmap <- data_mono %>% -->
<!--  mutate_at(vars(sel_markers_mono), asinh) %>% -->
<!--  mutate_at(vars(sel_markers_mono), scale) %>% -->
<!--  filter(Disease.phase == "acute") %>% -->
<!--  select(sel_markers_mono,Rpheno) %>% -->
<!--  group_by(Rpheno) %>% -->
<!--  summarise_at(vars(sel_markers_mono), funs(mean(., na.rm=TRUE))) %>% -->
<!--  column_to_rownames("Rpheno") -->

<!-- data_heatmap %>% t() %>% -->
<!--  Heatmap(name = "z-score avg", -->
<!--          cluster_rows = FALSE, -->
<!--          cluster_columns = TRUE, -->
<!--          rect_gp = gpar(col = "white", lwd = 2), -->
<!--          column_dend_height = unit(4, "cm"), -->
<!--          column_names_rot = 45, -->
<!--          #row_split = markers_category, -->
<!--          row_title_rot = 0 -->
<!--  ) -->

<!-- ``` -->

<!-- ### Cluster abundance -->

<!-- * What is the abundance of each cluster in each sample?  -->
<!-- * Is there any COVID-specific cluster? -->
<!-- * ACHTUNG! In this data set, donors where sampled multiple times during the disease course. For statistical purposes, we need to select one sample per donor. Hence, we establish an arbitrary rule of choosing the first sample per donor when multiple samples are available. -->

<!-- #### Select first sample per donor. -->

<!-- For the non-weekly analysis, we considered the first sample per patient when multiple samples were available. -->

<!-- ```{r defineIDs_m} -->
<!-- selected_ids <- data_Tcell %>%  -->
<!--   filter(Disease.phase == "acute") %>%  -->
<!--  count(Individuals,id,Group,sev_merge,Days.post.symptom.onset) %>%  -->
<!--  select(-n) %>%  -->
<!--  group_by(Individuals) %>% -->
<!--  mutate(n_samples = 1:n()) %>%  -->
<!--  mutate(select_id = ifelse(n_samples == 1, TRUE, -->
<!--                                   ifelse(min(as.numeric(Days.post.symptom.onset)) == as.numeric(Days.post.symptom.onset),  -->
<!--                                          TRUE, -->
<!--                                          FALSE))) %>% -->
<!--  filter(select_id) %>% -->
<!--  pull(id) -->
<!-- ``` -->


<!-- #### Cluster abundance (non-weekly analysis)  {.tabset} -->

<!-- * Calculate the abundance of each cluster in each selected donor, and visualize it with boxplots grouped by severity.  -->

<!-- ```{r boxplot_clust_abundance_m, fig.height=10, fig.width=10} -->

<!--  data_mono %>%  -->
<!--  filter(id %in% selected_ids) %>%  -->
<!--  count(id,sev_merge,Rpheno) %>%  -->
<!--  group_by(id) %>%  -->
<!--  mutate(perc = n/sum(n)*100) %>%  -->
<!--  ungroup() %>%  -->
<!--   # When using the function count(), if a cluster is absent in a donor, it will not be counted as zero.  -->
<!--   # So we complete the count table by filling the missing clusters with a 0. -->
<!--  tidyr::complete(id,Rpheno,fill = list(n=0,perc = 0)) %>%  -->
<!--  ungroup() %>%  -->
<!--  group_by(id) %>%  -->
<!--  fill(sev_merge, .direction = "downup") %>%  -->
<!--  ungroup() %>%  -->
<!--  mutate(perc = ifelse(is.na(perc),0,perc)) %>%  -->
<!--  ggplot(aes(x = sev_merge, y = perc, fill = sev_merge)) +  -->
<!--  geom_boxplot() +  -->
<!--  geom_jitter()+ -->
<!--  facet_wrap(~Rpheno, scale = "free") +  -->
<!--  scale_fill_manual(values = color_severity) +  -->
<!--  theme(axis.text.x = element_blank()) -->

<!-- ``` -->


